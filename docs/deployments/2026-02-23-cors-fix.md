# Hotfix Report: CORS Duplicate Headers

**Date**: February 23, 2026
**Issue**: Explorer unable to fetch timestamp data from metrics service
**Severity**: High (breaks Explorer functionality)

## Problem

Explorer showed CORS errors in the browser console when trying to fetch timestamp data:

```
Access to XMLHttpRequest at 'https://metrics.accumulatenetwork.io/v1/timestamp/...'
from origin 'http://localhost:3000' has been blocked by CORS policy.
The 'Access-Control-Allow-Origin' header contains multiple values '*, *', but only one is allowed.
```

This resulted in:
- Timestamp fields showing "N/A"
- Block numbers showing "N/A"
- Network errors in console

## Root Cause

Both the Nginx reverse proxy and the Go application were setting CORS headers:

1. **Nginx config** (`/etc/nginx/sites-available/metrics`):
   ```nginx
   add_header Access-Control-Allow-Origin * always;
   add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
   add_header Access-Control-Allow-Headers "Content-Type" always;
   ```

2. **Go app CORS middleware** (`main.go`):
   ```go
   func corsMiddleware(next http.Handler) http.Handler {
       return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
           w.Header().Set("Access-Control-Allow-Origin", "*")
           w.Header().Set("Access-Control-Allow-Methods", "GET, OPTIONS")
           w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
           // ...
       })
   }
   ```

This caused the response to contain duplicate `Access-Control-Allow-Origin` headers, which browsers reject as invalid.

## Solution

Removed the CORS middleware from the Go application (`main.go`):
- Deleted `corsMiddleware` function
- Removed `router.Use(corsMiddleware)` call

Nginx continues to handle CORS headers for all responses.

## Verification

Tested CORS headers after fix:

```bash
$ curl -I https://metrics.accumulatenetwork.io/v1/supply | grep -i access-control
access-control-allow-origin: *
access-control-allow-methods: GET, OPTIONS
access-control-allow-headers: Content-Type
```

Only one set of CORS headers present âœ“

## Files Modified

- `metrics-service/main.go` - Removed duplicate CORS middleware

## Deployment

1. Rebuilt service: `go build -o metrics-service`
2. Deployed to dal-server1 using `./deploy.sh`
3. Service restarted automatically via systemd
4. Verified endpoints working with single CORS headers

## Testing

Explorer now successfully fetches:
- Transaction timestamps
- Block numbers (minor and major)
- Transaction status (pending/delivered)
- Supply metrics

## Commits

```
d1af666 fix: Remove duplicate CORS headers causing browser errors
```

## Lessons Learned

When using a reverse proxy (Nginx) in front of an application:
- Only set CORS headers in ONE place (either proxy or app, not both)
- Prefer setting CORS in the proxy layer for centralized control
- Always check response headers with `curl -I` to verify no duplicates

## Related Issues

This fix completes the metrics service deployment started earlier today:
- User creation and permissions (commit f84afef)
- Deployment script improvements (commit bfc137e)
- CORS header deduplication (commit d1af666)
